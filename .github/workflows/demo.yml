name: Generate Demo Preview

# Trigger workflow on push to main or manual dispatch
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Demo Dashboard
        uses: sidbhasin13/sbom-ui-action@main
        with:
          sbom-files: 'nonexistent-pattern-*.json'  # This will trigger sample data generation
          output-dir: 'demo-dashboard'
          title: 'SBOM UI Action - Live Demo'
          theme: 'dark'

      - name: Add demo notice and preview instructions
        run: |
          # Add a prominent demo notice to the HTML
          cat > demo-dashboard/demo-notice.html << 'EOF'
          <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(90deg, #ff6b6b, #4ecdc4); color: white; padding: 15px; text-align: center; z-index: 1000; font-family: Arial, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <strong>DEMO PREVIEW:</strong> This shows sample data for demonstration purposes. Your actual SBOM data will be safe and private when you use this action in your own repository.
          </div>
          <script>
            // Add some padding to body to account for the notice
            document.body.style.paddingTop = '60px';
          </script>
          EOF
          
          # Create a comprehensive preview guide
          cat > demo-dashboard/PREVIEW-GUIDE.md << 'EOF'
          # SBOM UI Action - Live Demo Preview
          
          ## What You're Seeing
          This is a **preview** of how your SBOM dashboard will look when you use the `sidbhasin13/sbom-ui-action` in your own repository.
          
          ## Data Safety
          - **This is SAMPLE DATA** - No real vulnerabilities or sensitive information
          - **Your actual SBOM data stays private** in your repository
          - **No data is shared** with external services
          
          ## How to Use in Your Repository
          
          ### 1. Add to Your Workflow
          ```yaml
          name: Generate SBOM Dashboard
          on: [push, workflow_dispatch]
          
          jobs:
            generate-dashboard:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                
                - name: Generate SBOM UI
                  uses: sidbhasin13/sbom-ui-action@main
                  with:
                    sbom-files: '**/*.json'  # Adjust pattern for your SBOM files
                    output-dir: 'sbom-dashboard'
                    title: 'My Project SBOM Dashboard'
          ```
          
          ### 2. Deploy Options
          The action generates everything you need for deployment:
          - **Static files** ready for any hosting platform
          - **GitHub Pages workflow** (if you want to use GitHub Pages)
          - **Deployment instructions** for other platforms
          
          ### 3. Supported Platforms
          - GitHub Pages
          - Netlify
          - Vercel
          - Any static hosting service
          
          ## Features You'll Get
          - Interactive vulnerability dashboard
          - Search and filter capabilities
          - CVSS score distribution charts
          - Component and license tracking
          - Responsive design for all devices
          
          ## Need Help ?
          Check the generated `DEPLOYMENT.md` file in your output directory for detailed instructions.
          EOF
          
          # Create a simple preview index
          cat > demo-dashboard/preview.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>SBOM UI Action - Preview</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .header { text-align: center; margin-bottom: 30px; }
                  .demo-notice { background: #e3f2fd; border: 1px solid #2196f3; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                  .btn { display: inline-block; background: #2196f3; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px 5px; }
                  .btn:hover { background: #1976d2; }
                  .feature { margin: 15px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #4caf50; }
                  .instructions { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  .file-list { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
                  .file-list li { margin: 5px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>SBOM UI Action - Live Preview</h1>
                      <p>See how your SBOM dashboard will look with this interactive demo</p>
                  </div>
                  
                  <div class="demo-notice">
                      <strong>Safe Demo:</strong> This shows sample data only. Your actual SBOM data remains private in your repository.
                  </div>
                  
                  <div class="instructions">
                      <h3>Important: Why You Need the Preview Scripts</h3>
                      <p><strong>Don't just double-click the HTML files!</strong> Due to browser security restrictions, opening HTML files directly won't work properly.</p>
                      
                      <div style="background: #ffebee; border: 1px solid #f44336; padding: 15px; border-radius: 5px; margin: 15px 0;">
                          <h4>What happens if you open HTML files directly:</h4>
                          <ul>
                              <li>Dashboard shows "Loading..." forever</li>
                              <li>No vulnerability data appears</li>
                              <li>Charts and filters don't work</li>
                              <li>Console shows CORS errors</li>
                          </ul>
                      </div>
                      
                      <div style="background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; border-radius: 5px; margin: 15px 0;">
                          <h4>How to preview correctly:</h4>
                          <ol>
                              <li><strong>Try double-clicking the scripts</strong> (easiest method)</li>
                              <li><strong>If double-clicking doesn't work:</strong> Right-click → "Run as administrator" (Windows) or open terminal and run manually</li>
                              <li><strong>If scripts don't work at all:</strong> Start a local server manually: <code>python3 -m http.server 8000</code></li>
                              <li><strong>Alternative servers:</strong> <code>npx serve .</code>, <code>php -S localhost:8000</code>, etc.</li>
                          </ol>
                      </div>
                  </div>
                  
                  <div class="feature">
                      <h3>Interactive Dashboard</h3>
                      <p>View the full interactive dashboard with sample vulnerability data</p>
                      <div class="file-list">
                          <strong>Files to open:</strong>
                          <ul>
                              <li><code>index.html</code> - Main dashboard (open in browser)</li>
                              <li><code>assets/</code> - CSS, JS, and data files</li>
                          </ul>
                      </div>
                  </div>
                  
                  <div class="feature">
                      <h3>Deployment Guide</h3>
                      <p>Learn how to deploy this to your own hosting platform</p>
                      <div class="file-list">
                          <strong>Files to read:</strong>
                          <ul>
                              <li><code>DEPLOYMENT.md</code> - Step-by-step deployment instructions</li>
                              <li><code>.github/workflows/deploy.yml</code> - GitHub Pages workflow (if using GitHub)</li>
                          </ul>
                      </div>
                  </div>
                  
                  <div class="feature">
                      <h3>Preview Guide</h3>
                      <p>Detailed information about features and usage</p>
                      <div class="file-list">
                          <strong>Files to read:</strong>
                          <ul>
                              <li><code>PREVIEW-GUIDE.md</code> - Complete usage instructions</li>
                              <li><code>README.md</code> - Project documentation</li>
                          </ul>
                      </div>
                  </div>
                  
                  <div style="text-align: center; margin-top: 30px; color: #666;">
                      <p>Ready to use in your repository? Just add the action to your workflow!</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Upload demo artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-ui-demo
          path: 'demo-dashboard'
          retention-days: 30

      - name: Create local preview server script
        run: |
          # Create a simple Python HTTP server script for local preview
          cat > demo-dashboard/start-preview.py << 'EOF'
          #!/usr/bin/env python3
          import http.server
          import socketserver
          import webbrowser
          import os
          import sys
          
          PORT = 8000
          
          class MyHTTPRequestHandler(http.server.SimpleHTTPRequestHandler):
              def end_headers(self):
                  # Add CORS headers to allow local file access
                  self.send_header('Access-Control-Allow-Origin', '*')
                  self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
                  self.send_header('Access-Control-Allow-Headers', 'Content-Type')
                  super().end_headers()
          
          def start_server():
              os.chdir(os.path.dirname(os.path.abspath(__file__)))
              
              with socketserver.TCPServer(("", PORT), MyHTTPRequestHandler) as httpd:
                  print(f"SBOM UI Preview Server starting...")
                  print(f"Serving files from: {os.getcwd()}")
                  print(f"Preview URL: http://localhost:{PORT}")
                  print(f"Main dashboard: http://localhost:{PORT}/index.html")
                  print(f"Preview guide: http://localhost:{PORT}/preview.html")
                  print(f"")
                  print(f"Press Ctrl+C to stop the server")
                  print(f"")
                  
                  # Try to open browser automatically
                  try:
                      webbrowser.open(f'http://localhost:{PORT}/preview.html')
                      print(f"Opened preview in your default browser")
                  except:
                      print(f"Could not open browser automatically. Please visit: http://localhost:{PORT}/preview.html")
                  
                  print(f"")
                  httpd.serve_forever()
          
          if __name__ == "__main__":
              try:
                  start_server()
              except KeyboardInterrupt:
                  print(f"\nServer stopped. Thanks for previewing!")
                  sys.exit(0)
          EOF
          
          # Make it executable
          chmod +x demo-dashboard/start-preview.py
          
          # Create a batch file for Windows users
          cat > demo-dashboard/start-preview.bat << 'EOF'
          @echo off
          echo Starting SBOM UI Preview Server...
          echo.
          echo This will start a local web server to preview your SBOM dashboard.
          echo The dashboard will open in your default browser.
          echo.
          echo Press Ctrl+C to stop the server when you're done.
          echo.
          python start-preview.py
          pause
          EOF
          
          # Create a shell script for Unix/Linux/Mac users
          cat > demo-dashboard/start-preview.sh << 'EOF'
          #!/bin/bash
          echo "Starting SBOM UI Preview Server..."
          echo ""
          echo "This will start a local web server to preview your SBOM dashboard."
          echo "The dashboard will open in your default browser."
          echo ""
          echo "Press Ctrl+C to stop the server when you're done."
          echo ""
          python3 start-preview.py
          EOF
          
          chmod +x demo-dashboard/start-preview.sh

      - name: Show preview info
        run: |
          echo "Demo preview generated successfully!"
          echo "Files created:"
          ls -la demo-dashboard/
          echo ""
          echo "How to preview your SBOM UI:"
          echo ""
          echo "1. Download the 'sbom-ui-demo' artifact from this workflow run"
          echo "2. Extract the zip file to a folder on your computer"
          echo "3. Start the preview server:"
          echo "    • Windows: Double-click 'start-preview.bat'"
          echo "    • Mac/Linux: Run './start-preview.sh' in terminal"
          echo "    • Manual: Run 'python3 start-preview.py' in the extracted folder"
          echo ""
          echo "4. Your browser will open automatically to show the preview"
          echo "    • Main dashboard: http://localhost:8000/index.html"
          echo "    • Preview guide: http://localhost:8000/preview.html"
          echo ""
          echo "Preview files available:"
          echo "  - preview.html (main preview page with instructions)"
          echo "  - index.html (interactive dashboard)"
          echo "  - PREVIEW-GUIDE.md (usage instructions)"
          echo "  - DEPLOYMENT.md (deployment options)"
          echo "  - start-preview.py (local server script)"
          echo ""
          echo "This works for both demo data AND your real SBOM data!"